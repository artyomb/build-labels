#!/usr/bin/env ruby
text = File.read(__FILE__)
shell = text.split(/^__END__\s*$/ , 2)[1] or abort("missing __END__")
exec "sh", "-eux", "-c", shell, "sh", *ARGV

__END__
set -eux

# Dockerfile:
#FROM ruby:3.4.4-slim-bookworm AS base
#FROM ruby:3.2.10-alpine AS base
## RUN gem install build-labels:0.0.71
#RUN install-docker-static
#
#RUN docker -v
## docker build  --network=host --progress=plain .

# TODO:
# RUN apk add --no-cache ca-certificates curl tar \
  # && arch="$(uname -m)" \
  # && case "$arch" in x86_64|amd64) a=x86_64;; aarch64|arm64) a=aarch64;; *) exit 1;; esac \
  # && url="https://download.docker.com/linux/static/stable/$a/" \
  # && v="$(curl -fsSL "$url" | sed -n 's/.*docker-\([0-9.][0-9.]*\)\.tgz.*/\1/p' | sort -V | tail -n1)" \
  # && curl -fsSL "${url}docker-${v}.tgz" | tar -xz -C /tmp \
  # && install -m 0755 /tmp/docker/docker /usr/local/bin/docker \
  # && docker -v

install_docker_static() {
    arch="$(uname -m)"
    case "$arch" in
        x86_64|amd64) docker_arch="x86_64" ;;
        aarch64|arm64) docker_arch="aarch64" ;;
        armv7l|armv7) docker_arch="armhf" ;;
        armv6l|armv6) docker_arch="armel" ;;
        ppc64le) docker_arch="ppc64le" ;;
        s390x) docker_arch="s390x" ;;
        *)
            echo "Unsupported architecture: $arch" >&2
            exit 1
            ;;
    esac
    base_url="https://download.docker.com/linux/static/stable/$docker_arch/"
    latest_version="$(
        curl -fsSL "$base_url" \
            | sed -n 's/.*docker-\([0-9.][0-9.]*\)\.tgz.*/\1/p' \
            | sort -t. -k1,1n -k2,2n -k3,3n -k4,4n \
            | tail -n 1
    )"
    if [ -z "$latest_version" ]; then
        echo "Unable to determine latest Docker version from $base_url" >&2
        exit 1
    fi
    tmp_dir="$(mktemp -d)"
    curl -fsSL "${base_url}docker-${latest_version}.tgz" -o "$tmp_dir/docker.tgz"
    tar -xzf "$tmp_dir/docker.tgz" -C "$tmp_dir"
    install -m 0755 "$tmp_dir/docker/docker" /usr/local/bin/docker
    rm -rf "$tmp_dir"
}

if command -v apt-get >/dev/null 2>&1; then
    apt-get update
    apt-get install -y --no-install-recommends git ca-certificates curl tar
    install_docker_static
    rm -rf /var/lib/apt/lists/*
elif command -v apk >/dev/null 2>&1; then
    apk add --no-cache git ca-certificates curl tar
    install_docker_static
else
    echo "Unsupported package manager: expected apt or apk." >&2
    exit 1
fi

docker -v
